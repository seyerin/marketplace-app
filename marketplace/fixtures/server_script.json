[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-07 14:41:23.103300",
  "module": "marketplace",
  "name": "Supplier Product Proposal",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Supplier Product Proposal",
  "script": "# Versi FINAL skrip Server Script\r\n\r\nif frappe.session.user != 'Guest':\r\n    # Ambil email dari username yang sedang login\r\n    user_email = frappe.db.get_value(\"User\", frappe.session.user, \"email\")\r\n\r\n    if user_email:\r\n        # Gunakan email untuk mencari di tabel Portal User\r\n        supplier_name = frappe.db.get_value(\r\n            \"Portal User\", # KESALAHANNYA DI SINI\r\n            {\"user\": user_email},\r\n            \"parent\"\r\n        )\r\n        frappe.msgprint(\"Supplier yang ditemukan adalah: \" + supplier_name)\r\n        if supplier_name:\r\n            doc.supplier = supplier_name\r\n        else:\r\n            frappe.throw(\"Gagal menemukan Supplier yang terhubung dengan email user ini.\")\r\n    else:\r\n        frappe.throw(\"Email user tidak ditemukan.\")",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-11 01:41:31.375918",
  "module": "marketplace",
  "name": "Approval Product Supplier",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Supplier Product Proposal",
  "script": "# Server Script: Supplier Product Proposal (After Save)\r\n# Tambahkan kondisi untuk memeriksa status dokumen \r\n# Kita juga memeriksa apakah item sudah pernah dibuat sebelumnya untuk menghindari duplikasi\r\n\r\n# --- LOGGING DITAMBAHKAN DI SINI ---\r\nfrappe.log_error(f\"Server script 'After Save' is running for doc: {doc.name}\", \"DEBUG - Server Script Run\")\r\nfrappe.log_error(f\"Current doc.stat is: {doc.stat}\", \"DEBUG - Status Check\")\r\nfrappe.log_error(f\"Current doc.amended_from is: {doc.amended_from}\", \"DEBUG - Amended From Check\")\r\n# --- AKHIR LOGGING ---\r\n\r\nif doc.stat == 'Approved' and not doc.item_created:\r\n    try:\r\n        frappe.log_error(f\"Creating new Item for proposal: {doc.name}\", \"DEBUG - New Item Flow\")\r\n        # 1. Buat dokumen Item baru\r\n        new_item = frappe.new_doc(\"Item\")\r\n        new_item.item_code = doc.name\r\n        new_item.item_name = doc.product_name\r\n        new_item.description = doc.description\r\n        new_item.item_group = doc.cat_product\r\n        new_item.stock_uom = doc.uom\r\n        new_item.image = doc.images\r\n        new_item.is_stock_item = 1\r\n\r\n        new_item.insert()\r\n\r\n        # 2. Buat record Item Price untuk harga beli (Standard Buying)\r\n        buying_price = frappe.new_doc(\"Item Price\")\r\n        buying_price.item_code = new_item.item_code\r\n        buying_price.price_list = \"Standard Buying\"\r\n        buying_price.price_list_rate = doc.supplier_price\r\n        buying_price.rate = doc.supplier_price\r\n        buying_price.insert()\r\n\r\n        # 3. Buat record Item Price untuk harga jual (Standard Selling)\r\n        selling_price = frappe.new_doc(\"Item Price\")\r\n        selling_price.item_code = new_item.item_code\r\n        selling_price.price_list = \"Standard Selling\"\r\n        selling_price.price_list_rate = doc.admin_selling_price\r\n        selling_price.rate = doc.admin_selling_price\r\n        selling_price.insert()\r\n\r\n        # 4. Buat dokumen Website Item baru\r\n        new_website_item = frappe.new_doc(\"Website Item\")\r\n        new_website_item.item_code = new_item.item_code\r\n        new_website_item.stock_uom = new_item.stock_uom\r\n        new_website_item.insert()\r\n\r\n        # Update dokumen proposal untuk menandai bahwa item sudah dibuat\r\n        frappe.db.set_value('Supplier Product Proposal', doc.name, 'item_created', 1)\r\n        \r\n        frappe.msgprint(\"Item, Item Price (buying & selling), dan Website Item berhasil dibuat secara otomatis.\")\r\n    except Exception as e:\r\n        frappe.log_error(title=\"Server Script Gagal Membuat Item Baru\", message=str(e))\r\n        frappe.throw(\"Gagal membuat Item dan Website Item: \" + str(e))\r\n        \r\nelif doc.stat == 'Pending' and doc.amended_from:\r\n    try:\r\n        frappe.log_error(f\"Updating existing Item Price for revised proposal: {doc.name}\", \"DEBUG - Revised Item Flow\")\r\n        # Dapatkan Item Code dari dokumen yang direvisi\r\n        old_item_code = frappe.get_value('Supplier Product Proposal', doc.amended_from, 'item_code')\r\n\r\n        if old_item_code:\r\n            # 1. Cari dan update Item Price untuk harga beli\r\n            buying_item_price = frappe.get_doc(\"Item Price\", {\"item_code\": old_item_code, \"price_list\": \"Standard Buying\"})\r\n            buying_item_price.rate = doc.supplier_price\r\n            buying_item_price.price_list_rate = doc.supplier_price\r\n            buying_item_price.save()\r\n\r\n            # 2. Cari dan update Item Price untuk harga jual\r\n            selling_item_price = frappe.get_doc(\"Item Price\", {\"item_code\": old_item_code, \"price_list\": \"Standard Selling\"})\r\n            selling_item_price.rate = doc.admin_selling_price\r\n            selling_item_price.price_list_rate = doc.admin_selling_price\r\n            selling_item_price.save()\r\n\r\n            # Tandai proposal baru sebagai \"sudah dibuat item\" agar tidak diproses lagi\r\n            frappe.db.set_value('Supplier Product Proposal', doc.name, 'item_created', 1)\r\n\r\n            frappe.msgprint(\"Harga Item berhasil diperbarui secara otomatis.\")\r\n        else:\r\n            frappe.log_error(\"Item Code tidak ditemukan dari dokumen asli.\", \"DEBUG - Item Not Found\")\r\n\r\n    except Exception as e:\r\n        frappe.log_error(title=\"Server Script Gagal Mengupdate Item Price\", message=str(e))\r\n        frappe.throw(\"Gagal memperbarui harga Item: \" + str(e))\r\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-08-07 14:44:22.260583",
  "module": "marketplace",
  "name": "Update Item Price on Approval",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Supplier Product Proposal",
  "script": "# Jalankan hanya kalau statusnya diubah menjadi Approved\r\nif doc.stat == \"Approved\":\r\n\r\n    # Update atau buat harga Buying\r\n    if not frappe.db.exists(\"Item Price\", {\r\n        \"item_code\": doc.product_name,\r\n        \"buying\": 1,\r\n        \"price_list\": \"Standard Buying\"\r\n    }):\r\n        frappe.get_doc({\r\n            \"doctype\": \"Item Price\",\r\n            \"item_code\": doc.product_name,\r\n            \"price_list\": \"Standard Buying\",\r\n            \"price_list_rate\": doc.supplier_price,\r\n            \"buying\": 1\r\n        }).insert(ignore_permissions=True)\r\n    else:\r\n        frappe.db.set_value(\"Item Price\", {\r\n            \"item_code\": doc.product_name,\r\n            \"buying\": 1,\r\n            \"price_list\": \"Standard Buying\"\r\n        }, \"price_list_rate\", doc.supplier_price)\r\n\r\n    # Update atau buat harga Selling (jika kamu pakai margin)\r\n    if doc.admin_selling_price:\r\n        if not frappe.db.exists(\"Item Price\", {\r\n            \"item_code\": doc.product_name,\r\n            \"selling\": 1,\r\n            \"price_list\": \"Standard Selling\"\r\n        }):\r\n            frappe.get_doc({\r\n                \"doctype\": \"Item Price\",\r\n                \"item_code\": doc.product_name,\r\n                \"price_list\": \"Standard Selling\",\r\n                \"price_list_rate\": doc.admin_selling_price,\r\n                \"selling\": 1\r\n            }).insert(ignore_permissions=True)\r\n        else:\r\n            frappe.db.set_value(\"Item Price\", {\r\n                \"item_code\": doc.product_name,\r\n                \"selling\": 1,\r\n                \"price_list\": \"Standard Selling\"\r\n            }, \"price_list_rate\", doc.admin_selling_price)\r\n\r\n    frappe.msgprint(\"Harga produk berhasil diupdate ke Item Price.\")\r\n",
  "script_type": "DocType Event"
 }
]